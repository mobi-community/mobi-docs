## âœ¨ `suspense`

> React v18.0ì— ì •ì‹ ê¸°ëŠ¥ìœ¼ë¡œ ì¶œì‹œí•˜ì˜€ìŠµë‹ˆë‹¤.

### ğŸ“‘ Summary

`Suspense`ë¥¼ í†µí•˜ì—¬ ì‘ì—…ì´ ëë‚  ë•Œê¹Œì§€ ë Œë”ë§ì„ ì ì‹œ ì¤‘ë‹¨ì‹œí‚¤ê³  ë¯¸ë¦¬ ë³´ì—¬ì¤„ ì»´í¬ë„ŒíŠ¸ë¥¼ ë Œë”ë§ ì‹œì¼œ ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```typescript
import { Suspense } from 'react';

import QueryComponent from './components/query-component';

function App() {
  return (
    <Suspense fallback={<div>Loading...</div>}>
      <PromiseComponent /> // ë°ì´í„° fetchingì„ í•˜ëŠ” ì»´í¬ë„ŒíŠ¸
    </Suspense>
  );
}
```

### ğŸ“– ì´ì „ì—ëŠ” ì–´ë–»ê²Œ ì‚¬ìš©í–ˆì„ê¹Œìš”?

í´ë˜ìŠ¤ ì»´í¬ë„ŒíŠ¸ì˜ ê²½ìš° lifeCycle í•¨ìˆ˜ì¸ `componentDidMount()`ë¥¼ ì‚¬ìš©í•˜ì—¬ êµ¬í˜„ì„ í•˜ì˜€ê³ , í•¨ìˆ˜í˜• ì»´í¬ë„ŒíŠ¸ì˜ ê²½ìš° `useEffect()`ë¥¼ í†µí•´ êµ¬í˜„ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.

```javascript
export default function TodoList() {
  const [todoList, setTodoList] = useState([]);
  // (1) ì´ˆê¸°ì˜ ë¡œë”© ìƒíƒœë¥¼ trueë¡œ ë§Œë“¤ì–´ë‘¡ë‹ˆë‹¤.
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(false);

  useEffect(() => {
    fetch('https://jsonplaceholder.typicode.com/todos')
      .then((res) => res.json())
      .then((newTodoList) => {
        setTodoList(newTodoList);
        setLoading(false);
      })
      .catch(() => setError(true));
  }, []);

  // (3) ê°’ì„ ë¶ˆëŸ¬ì˜¤ê¸° ì´ì „ì˜ ê²½ìš° loading í™”ë©´ì´ ë³´ì…ë‹ˆë‹¤.
  if (loading) return <p>ë¡œë”©ì¤‘ì…ë‹ˆë‹¤.</p>;
  if (error) return <p>ì—ëŸ¬ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.</p>;

  return (
    <>
      {todoList.map((todo) => (
        <div>{todo.title}</div>
      ))}
    </>
  );
}
```

ì´ì²˜ëŸ¼ ë³€ê²½ë˜ëŠ” ê°’ì„ ë§Œë“¤ì–´ì£¼ê¸° ìœ„í•´ì„œ ìƒíƒœ(state)ë¥¼ í†µí•´ ì§ì ‘ ë³´ì—¬ì¤„ ì»´í¬ë„ŒíŠ¸ë¥¼ ê²°ì • í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.

### ğŸ¤” ì´ì œëŠ” ì–´ë–»ê²Œ ì‚¬ìš©í• ê¹Œìš”?

ğŸ§ ì‘ë™ì›ë¦¬ëŠ” ì´ë ‡ìŠµë‹ˆë‹¤!

SuspenseëŠ” ì»´í¬ë„ŒíŠ¸ íŠ¸ë¦¬ ì „ì²´ì— ê±¸ì³ ë¡œë”© ìƒíƒœë¥¼ í†µí•©ì ìœ¼ë¡œ ê´€ë¦¬í•  ìˆ˜ ìˆê²Œ ë„ì™€ì¤ë‹ˆë‹¤. ì—¬ëŸ¬ê°œì˜ ë¹„ë™ê¸° ì‘ì—…ì´ ë™ì‹œì— ìˆ˜í–‰ì´ ë˜ëŠ” ê²½ìš°ì—ë„, ë¡œë”© í‘œì‹œìë¥¼ ë‹¨ í•œ ë²ˆë§Œ í‘œì‹œí•  ìˆ˜ ìˆë„ë¡ ë„ì™€ì¤ë‹ˆë‹¤.

Suspenseì˜ í•µì‹¬ì ì¸ ë™ì‘ ë°©ì‹ì€ javascriptì˜ Promiseë¥¼ throwí•˜ëŠ” ê²ƒì— ìˆìŠµë‹ˆë‹¤.
Promiseê°€ throwë˜ë©´ ReactëŠ” í•´ë‹¹ ì»´í¬ë„ŒíŠ¸ì˜ ë Œë”ë§ì„ ì¼ì‹œ ì¤‘ë‹¨ì‹œí‚¤ê³ , Promiseê°€ ì´í–‰(resolve), ì‚¬ë¼ì§ˆ ë•Œê¹Œì§€ ê¸°ë‹¤ë¦½ë‹ˆë‹¤.

ì´í›„ Promiseê°€ ì´í–‰, ì‚¬ë¼ì§ˆ ê²½ìš° Suspense ì»´í¬ë„ŒíŠ¸ë‚´ childrenì„ ì¬ë Œë”ë§ ì‹œí‚µë‹ˆë‹¤. ì´ë•ŒëŠ” ë” ì´ìƒ Promiseê°€ throw ë˜ì§€ ì•Šìœ¼ë¯€ë¡œ ì •ìƒì ìœ¼ë¡œ ì¬ë Œë”ë§ ë©ë‹ˆë‹¤.

ì•„ë˜ëŠ” Promiseì˜ ìƒíƒœë¥¼ ì¶”ì í•˜ë©° í•„ìš”í•œ ë™ì‘ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆëŠ” Wrapper í•¨ìˆ˜ì…ë‹ˆë‹¤.

```javascript
export const promiseWrapper = (promise) => {
  let status = 'pending'; // í˜„ì¬ ìƒíƒœë¥¼ ë‚˜íƒ€ë‚´ëŠ” ë³€ìˆ˜
  let result; // Promiseê°€ ì„±ê³µí–ˆì„ ë•Œì˜ ê²°ê³¼ ê°’ì„ ì €ì¥í•˜ëŠ” ë³€ìˆ˜

  const subscription = promise.then(
    (value) => {
      status = 'success'; // ìƒíƒœë¥¼ 'success'ë¡œ ë³€ê²½
      result = value; // ì„±ê³µí•œ ê²½ìš° ê²°ê³¼ ê°’ì„ ì €ì¥
    },
    (error) => {
      status = 'error'; // ìƒíƒœë¥¼ 'error'ë¡œ ë³€ê²½
      result = error; // ì‹¤íŒ¨í•œ ê²½ìš° ì—ëŸ¬ ê°’ì„ ì €ì¥
    }
  );

  return {
    read() {
      switch (status) {
        case 'pending':
          throw subscription; // Suspense ë Œë”ë§ (promiseë¥¼ throw í•©ë‹ˆë‹¤.)
        case 'success':
          return result; // ë°ì´í„° ë°˜í™˜
        case 'error':
          throw result; // ì—ëŸ¬ë¥¼ throw
        default:
          throw new Error('ì•Œ ìˆ˜ ì—†ëŠ” ìƒíƒœ'); // ì•Œ ìˆ˜ ì—†ëŠ” ìƒíƒœì¼ ê²½ìš° ì—ëŸ¬ throw
      }
    },
  };
};
```

ğŸ«¡ ì½”ë“œëŠ” ì´ë ‡ê²Œ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!

1. ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜ë¥¼ ë§Œë“­ë‹ˆë‹¤. ì´ í•¨ìˆ˜ëŠ” ë°ì´í„°ê°€ ì—†ë‹¤ë©´ promiseë¥¼ throwë¥¼ í•˜ê³  ë°ì´í„°ê°€ ìˆì„ ê²½ìš° todosë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.

```javascript
export default function fetchPost() {
  let todos = null;
  const promise = fetch('https://jsonplaceholder.typicode.com/todos')
    .then((res) => res.json())
    .then((data) => {
      setTimeout(() => {
        todos = data;
      }, 3000);
    });
  return {
    read() {
      if (todos === null) {
        throw promise;
      } else {
        return todos;
      }
    },
  };
}
```

2. `<Suspense/>`ë¥¼ ì´ìš©í•˜ì—¬ ì‚¬ìš©í•˜ëŠ” ì»´í¬ë„ŒíŠ¸ë¥¼ ê°ì‹¸ì¤ë‹ˆë‹¤.

```javascript
function App() {
  return (
    <Suspense fallback={<p>ë¡œë”©ì¤‘ì…ë‹ˆë‹¤.</p>}>
      <TodoList fetchPost={fetchPost()} />
    </Suspense>
  );
}
```

3. propsë¡œ ì „ë‹¬ë°›ì•„ ì‹¤í–‰í•˜ì—¬ ì¤ë‹ˆë‹¤.

```javascript
import React from 'react';

export default function TodoList({ fetchPost }) {
  const todoList = fetchPost.read();

  return (
    <>
      {todoList.map((todo) => (
        <div>{todo.title}</div>
      ))}
    </>
  );
}
```

ì´ë•Œ ë§Œì•½ `fetchPost.read()`ì˜ ë°˜í™˜ ê°’ì´ Promise íƒ€ì…ì„ throw í•˜ê³  ìˆì„ê²½ìš° `<Suspense/>`ì˜ `fallback`ì— ë“¤ì–´ê°€ìˆëŠ” ì»´í¬ë„ŒíŠ¸ê°€ ë³´ì—¬ì§‘ë‹ˆë‹¤.

### ì‹¤ì œ ì½”ë“œë¡œ ë³´ê¸°

ì‹¤ì œ íƒ€ì…ìŠ¤í¬ë¦½íŠ¸ì—ì„œì˜ ì½”ë“œëŠ” ë‹¤ìŒê³¼ ê°™ì´ ì‚¬ìš©í•©ë‹ˆë‹¤.

```typescript
export default function App() {
  return (
    // ReactQueryë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„œëŠ” QueryClientProviderë¥¼ ì ìš©ì‹œì¼œì¤ë‹ˆë‹¤.
    <QueryClientProvider client={new QueryClient()}>
      <Suspense fallback={<div>Loading...</div>}>
        <QueryComponent />
      </Suspense>
    </QueryClientProvider>
  );
}

// ë¦¬ì•¡íŠ¸ ì¿¼ë¦¬ì™€ ê°™ì´ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
// ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ê³  ìˆëŠ” ìƒíƒœë¼ë©´ Suspenseì˜ fallbackì´ ë³´ì—¬ì§‘ë‹ˆë‹¤.

type UserType = {
  userId: number;
  id: number;
  title: string;
  completed: boolean;
};

const userListOption = {
  getUserConfig: queryOptions({
    queryKey: ['userList'],
    queryFn: async () => {
      // ì§€ì—°ì‹œê°„ì„ ê±¸ì–´ì£¼ê¸° ìœ„í•´ ì¼ë¶€ë¡œ setTimeout ê±¸ì–´ë‘ì—ˆìŠµë‹ˆë‹¤.
      await new Promise((resolve) => {
        setTimeout(resolve, 1000);
      });
      const { data } = await axios.get<UserType[]>('https://jsonplaceholder.typicode.com/todos');
      return data;
    },
  }),
};

export default function QueryComponent() {
  // ReactQuery v5ë¶€í„°ëŠ” optionìœ¼ë¡œ Suspenseë¥¼ ì„ íƒí•´ì£¼ëŠ” ê²ƒì´ ì•„ë‹Œ useSuspenseQueryë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
  // useSuspenseQueryë¥¼ í†µí•´ ë°˜í™˜ë˜ëŠ” ê°’ì€ undefindê°€ ì•„ë‹Œ ì •í•´ë‘ì—ˆë˜ Tíƒ€ì…ì˜ ë°ì´í„°ë§Œ ëŒì•„ì˜¤ê¸° ë•Œë¬¸ì— undefinedì¼ ë•Œì˜ ë¡œì§ì„ ìƒê°í•˜ì§€ ì•Šì•„ë„ ë©ë‹ˆë‹¤.
  const { data: userList } = useSuspenseQuery(userListOption.getUserConfig);

  return (
    <ul>
      {userList.map((user) => (
        <li key={user.id}>{user.title}</li>
      ))}
    </ul>
  );
}
```

### ğŸ“¢ ì‚¬ìš© ì‹œ ì£¼ì˜í•  ì 

> SuspenseëŠ” Effectë‚˜ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ë‚´ë¶€ì—ì„œ í˜ì¹­í•˜ëŠ” ê²½ìš°ë¥¼ ê°ì§€í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

ë‹¤ìŒ ì½”ë“œì—ì„œëŠ” ë™ì‘í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

```javascript
function App() {
  return (
    <Suspense fallback={<p>ë¡œë”©ì¤‘ì…ë‹ˆë‹¤.</p>}>
      <TodoList />
    </Suspense>
  );
}

function TodoList() {
  const [todoList, setTodoList] = useState([]);

  useEffect(() => {
    fetch('https://jsonplaceholder.typicode.com/todos')
    .then((res) => setTodoList(res.json()));
  }, []);

  return (
    <div>
    {todoList.map(todo=> <OneTodo {...todo}>)}
    </div>
  );
}
```

### ğŸš¨ TroubleShooting

- **Suspenseì™€ í˜¸í™˜ë˜ì§€ ì•ŠëŠ” ë¹„ë™ê¸° ì‘ì—…**

  SuspenseëŠ” íŠ¹ì •í•œ ë™ì‘ ë°©ì‹ì„ ì¤€ìˆ˜í•˜ëŠ” ë¹„ë™ê¸° ì‘ì—…ì— ëŒ€í•´ì„œë§Œ ì •ìƒì ìœ¼ë¡œ ë™ì‘í•©ë‹ˆë‹¤. ê·¸ë ‡ì§€ ì•ŠëŠ”ë‹¤ë©´ ì˜ˆìƒì¹˜ ëª»í•œ ì—ëŸ¬ë‚˜ ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.

  SuspenseëŠ” Promiseë¥¼ ìºì¹˜í•˜ëŠ” ë°©ì‹ìœ¼ë¡œë§Œ ë™ì‘ì„ í•˜ê¸° ë•Œë¬¸ì— ë°ì´í„° ë¡œë”© í•¨ìˆ˜ê°€ Promiseë¥¼ throw í•˜ì§€ ì•ŠëŠ”ë‹¤ë©´ ì—ëŸ¬ë‚˜ ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤. ë•Œë¬¸ì— ì´ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ì„œëŠ” `promiseWrapper()` í•¨ìˆ˜ì™€ ê°™ì´ íŠ¹ì • ìƒíƒœì¼ ê²½ìš° Promiseë¥¼ throwí•˜ëŠ” í•¨ìˆ˜ë¥¼ ë§Œë“ ë‹¤ë˜ì§€ ì•„ë‹ˆë©´ ReactQueryì™€ ê°™ì´ ì´ëŸ¬í•œ ê²ƒë“¤ì„ ì§€ì›í•˜ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### ğŸ” References

- [React-Suspense-Reference](https://react.dev/reference/react/Suspense)
- [[React] Suspenseì„ ì‚¬ìš©í•´ ì„ ì–¸ì ìœ¼ë¡œ ë¡œë”© í™”ë©´ êµ¬í˜„í•˜ê¸°](https://lasbe.tistory.com/160)
- [React ë¡œë”©ì²˜ë¦¬ì™€ Suspenseì˜ ë“±ì¥](https://www.jungmin.me/post/react-%EB%A1%9C%EB%94%A9%EC%B2%98%EB%A6%AC%EC%99%80-suspense-%EB%93%B1%EC%9E%A5)
- [React Suspenseì˜ ë‚´ë¶€ ë™ì‘ë°©ì‹](https://www.jungmin.me/post/react-suspense-%EB%82%B4%EB%B6%80-%EB%8F%99%EC%9E%91%EB%B0%A9%EC%8B%9D)
